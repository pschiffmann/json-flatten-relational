import{j as _,R as C,r as m,X as w,a as R}from"./vendor.6d3c68ff.js";const M=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&c(o)}).observe(document,{childList:!0,subtree:!0});function r(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerpolicy&&(s.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?s.credentials="include":e.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function c(e){if(e.ep)return;e.ep=!0;const s=r(e);fetch(e.href,s)}};M();function T(t,n){switch(n.type){case"literal":return t===n.key;case"index":return typeof t=="number";case"regexp":return new RegExp(n.pattern,n.flags).test(t.toString());case"**":return!0}}function $(t,n,r,c){if(!r.capture)return c;const e=new Map(c);function s(o,a,u=","){if(r.type!=="**")e.set(o,a);else if(!e.has(o))e.set(o,`${a}`);else{const h=e.get(o);e.set(o,`${h}${u}${a}`)}}if(r.capture.key!==void 0&&s(r.capture.key,t),r.capture.columns)for(const[o,a]of Object.entries(r.capture.columns)){const u=N(n,a);(u!==void 0||r.type==="**")&&s(o,u,a.delimiter)}return e}function N(t,n){const r=n.path&&j(t,n.path),c=n.self?t:void 0;return r!=null?r:c}function j(t,n){if(typeof t!="object"||t===null)return;const[r,...c]=n;if(typeof r=="number"===Array.isArray(t))return c.length?j(t[r],c):t[r]}function L(t){if(!t.path.length)throw new b(t.tableName,"Path must not be empty.");if(t.path[t.path.length-1].type==="**")throw new b(t.tableName,"Path must not end with a wildcard matcher.");const n=new Set;function r(e){if(n.has(e))throw new b(t.tableName,`Two path matchers write to the column ${e}`);n.add(e)}for(const e of t.path){if(!e.capture)continue;const{key:s,columns:o}=e.capture;s!==void 0&&r(s),o&&Object.getOwnPropertyNames(o).forEach(r)}const c=new Set;for(const e of Object.getOwnPropertyNames(t.columns)){if(n.has(e))throw new b(t.tableName,`A path matcher and a value column write to the column ${e}`);c.add(e)}return{captureColumns:n,valueColumns:c}}class b extends Error{constructor(n,r){super(r);this.tableName=n}toString(){return`Error in table resolver ${this.tableName}: ${this.message}`}}function P(t,n){const r=[],c=new Map,e=new Map;for(const a of n){const{captureColumns:u,valueColumns:h}=L(a);r.push({tableResolver:a,nextPathMatcher:0,captures:new Map});const{tableName:p}=a;let d=c.get(p),l=e.get(p);d||(c.set(p,d=new Set),e.set(p,l=new Set));for(const f of u)d.add(f);for(const f of h)l.add(f)}const s=new Map;for(const[a,u]of c){const h=e.get(a),p=new Set;for(const d of u)p.add(d);for(const d of h)p.add(d);s.set(a,{header:p,rows:[]})}function o(a,u){s.get(a).rows.push(u)}return k(t,r,o),s}function k(t,n,r){if(typeof t!="object"||t===null)return;const c=Array.isArray(t)?t.entries():Object.entries(t);for(const[e,s]of c){const o=[];for(const{tableResolver:a,nextPathMatcher:u,captures:h}of n){const p=a.path[u];if(!T(e,p))continue;const d=p.capture?$(e,s,p,h):h;u===a.path.length-1?U(s,a,d,r):(o.push({tableResolver:a,nextPathMatcher:u+1,captures:d}),p.type==="**"&&o.push({tableResolver:a,nextPathMatcher:u,captures:d}))}o.length!==0&&k(s,o,r)}}function U(t,n,r,c){const e={};for(const[s,o]of r)e[s]=o;for(const[s,o]of Object.entries(n.columns)){const a=N(t,o);switch(typeof a){case"boolean":case"number":case"string":e[s]=a;break;case"object":e[s]=JSON.stringify(a);break}}c(n.tableName,e)}const i=_.exports.jsx,y=_.exports.jsxs,A=C.memo(({name:t,data:n})=>{const[r,c]=m.exports.useState(!1),e=m.exports.useCallback(o=>{c(o.currentTarget.open)},[]),s=[...n.header];return y("details",{className:"table-preview",open:r,onToggle:e,children:[i("summary",{className:"table-preview__name",children:t}),r&&i("div",{className:"table-preview__container",children:y("table",{className:"table-preview__table",children:[i("thead",{children:i("tr",{children:s.map(o=>i("th",{className:"table-preview__header",children:o},o))})}),i("tbody",{children:n.rows.map((o,a)=>i("tr",{className:"table-preview__row",children:s.map(u=>{const h=o[u];return i("td",{className:"table-preview__cell table-preview__cell--"+typeof h,children:h},u)})},a))})]})})]})}),D=()=>{const[t,n]=m.exports.useState(""),[r,c]=m.exports.useState(""),[e,s]=m.exports.useState();m.exports.useEffect(()=>{fetch("sample-data.json").then(l=>l.text()).then(l=>n(f=>f!==""?f:l)),fetch("sample-schema.json").then(l=>l.text()).then(l=>c(f=>f!==""?f:l))},[]);const[o,a]=m.exports.useState();m.exports.useEffect(()=>{if(!!o)return()=>{URL.revokeObjectURL(o)}},[o]);const u=m.exports.useCallback(l=>{n(l.currentTarget.value),s(void 0),a(void 0)},[]),h=m.exports.useCallback(l=>{c(l.currentTarget.value),s(void 0),a(void 0)},[]);function p(){try{const l=J(t),f=V(r);s(P(l,f.resolvers))}catch(l){throw alert(`${l}`),l}}function d(){const l=w.utils.book_new();for(const[O,x]of e){const v=[...x.header],E=w.utils.aoa_to_sheet([v,...x.rows.map(g=>v.map(S=>g[S]!==null?g[S]:"null"))]);w.utils.book_append_sheet(l,E,O)}const f=w.write(l,{type:"array",bookType:"xlsx"});a(URL.createObjectURL(new Blob([f],{type:"application/octet-stream"})))}return y("div",{className:"app",children:[i("h1",{children:"json-flatten-relational"}),i("a",{className:"app__link",href:"https://github.com/pschiffmann/json-flatten-relational#readme",target:"_blank",children:"Docs"}),i("h2",{children:"JSON source"}),i("textarea",{className:"app__textarea",value:t,onChange:u}),i("h2",{children:"Schema"}),i("textarea",{className:"app__textarea",value:r,onChange:h}),i("h2",{children:"Result"}),!e&&i("button",{onClick:p,children:"Run"}),e&&[...e].map(([l,f])=>i(A,{name:l,data:f},l)),e&&(o?i("a",{href:o,download:"untitled.xlsx",children:"Download as .xlsx"}):i("button",{onClick:d,children:"Export as .xslx"}))]})};function J(t){try{return JSON.parse(t)}catch(n){throw n instanceof SyntaxError?new Error(`Invalid JSON source syntax:
${n}`):n}}function V(t){let n;try{n=JSON.parse(t)}catch(r){throw r instanceof SyntaxError?new Error(`Invalid schema syntax:
${r}`):r}if(n.version!=="2")throw new Error("Unsupported schema version.");if(typeof n.resolvers!="object")throw new Error("Schema has no table resolvers.");return n}R.render(i(C.StrictMode,{children:i(D,{})}),document.querySelector("#root"));

import{j as S,R as _,r as m,X as w,a as R}from"./vendor.6d3c68ff.js";const k=function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function o(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerpolicy&&(e.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?e.credentials="include":n.crossorigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function l(n){if(n.ep)return;n.ep=!0;const e=o(n);fetch(n.href,e)}};k();function E(t,r){switch(r.type){case"literal":return t===r.key;case"index":return typeof t=="number";case"regexp":return new RegExp(r.pattern,r.flags).test(t.toString());case"**":return!0}}function T(t,r,o){var a;const{type:l,captureName:n}=r;if(!n)return o;const e=new Map(o);if(l==="**"&&e.has(n)){const s=e.get(n),i=(a=r.captureDelimiter)!=null?a:",";e.set(n,`${s}${i}${t}`)}else e.set(n,t);return e}function P(t){if(!t.path.length)throw new b(t.tableName,"Path must not be empty.");if(t.path[t.path.length-1].type==="**")throw new b(t.tableName,"Path must not end with a wildcard matcher.");const r=new Set,o=new Set(Object.getOwnPropertyNames(t.columns));let l=!1;for(const{type:n,captureName:e}of t.path){if(n==="**"&&l)throw new b(t.tableName,"Path must not contain two consecutive Wildcard matchers.");if(l=n==="**",e!==void 0){if(r.has(e)||o.has(e))throw new b(t.tableName,"Two path matchers or value columns write to the column "+e);r.add(e)}}return{captureColumns:r,valueColumns:o}}function L(t,r,o){var i;const{self:l,path:n,startAtAncestor:e}=o,a=e===void 0?t:e>=0?r[e]:r[r.length+e],s=(i=n&&C(a,n))!=null?i:l?a:void 0;switch(typeof s){case"number":case"string":case"undefined":return s;default:return JSON.stringify(s)}}function C(t,r){if(typeof t!="object"||t===null)return;const[o,...l]=r;if(typeof o=="number"===Array.isArray(t))return l.length?C(t[o],l):t[o]}class b extends Error{constructor(r,o){super(o);this.tableName=r}toString(){return`Error in table resolver ${this.tableName}: ${this.message}`}}function A(t,r){const o=[],l=new Map,n=new Map;for(const s of r){const{captureColumns:i,valueColumns:p}=P(s);o.push({tableResolver:s,nextPathMatcher:0,captures:new Map}),s.path[0].type==="**"&&o.push({tableResolver:s,nextPathMatcher:1,captures:new Map});const{tableName:d}=s;let f=l.get(d),c=n.get(d);f||(l.set(d,f=new Set),n.set(d,c=new Set));for(const h of i)f.add(h);for(const h of p)c.add(h)}const e=new Map;for(const[s,i]of l){const p=n.get(s),d=new Set;for(const f of i)d.add(f);for(const f of p)d.add(f);e.set(s,{header:d,rows:[]})}function a(s,i){e.get(s).rows.push(i)}return j(t,[],o,a),e}function j(t,r,o,l){if(typeof t!="object"||t===null)return;const n=Array.isArray(t)?t.entries():Object.entries(t);for(const[e,a]of n){const s=[];for(const{tableResolver:i,nextPathMatcher:p,captures:d}of o){const f=i.path[p];if(!E(e,f))continue;const c=f.captureName?T(e,f,d):d;p===i.path.length-1?D(a,r,i,c,l):(s.push({tableResolver:i,nextPathMatcher:p+1,captures:c}),f.type==="**"?s.push({tableResolver:i,nextPathMatcher:p,captures:c}):i.path[p+1].type==="**"&&s.push({tableResolver:i,nextPathMatcher:p+2,captures:c}))}s.length!==0&&j(a,[a,...r],s,l)}}function D(t,r,o,l,n){const e={};for(const[a,s]of l)e[a]=s;for(const[a,s]of Object.entries(o.columns))e[a]=L(t,r,s);n(o.tableName,e)}const u=S.exports.jsx,y=S.exports.jsxs,U=_.memo(({name:t,data:r})=>{const[o,l]=m.exports.useState(!1),n=m.exports.useCallback(a=>{l(a.currentTarget.open)},[]),e=[...r.header];return y("details",{className:"table-preview",open:o,onToggle:n,children:[u("summary",{className:"table-preview__name",children:t}),o&&u("div",{className:"table-preview__container",children:y("table",{className:"table-preview__table",children:[u("thead",{children:u("tr",{children:e.map(a=>u("th",{className:"table-preview__header",children:a},a))})}),u("tbody",{children:r.rows.map((a,s)=>u("tr",{className:"table-preview__row",children:e.map(i=>{const p=a[i];return u("td",{className:"table-preview__cell table-preview__cell--"+typeof p,children:p},i)})},s))})]})})]})}),$=()=>{const[t,r]=m.exports.useState(""),[o,l]=m.exports.useState(""),[n,e]=m.exports.useState();m.exports.useEffect(()=>{fetch("sample-data.json").then(c=>c.text()).then(c=>r(h=>h!==""?h:c)),fetch("sample-schema.json").then(c=>c.text()).then(c=>l(h=>h!==""?h:c))},[]);const[a,s]=m.exports.useState();m.exports.useEffect(()=>{if(!!a)return()=>{URL.revokeObjectURL(a)}},[a]);const i=m.exports.useCallback(c=>{r(c.currentTarget.value),e(void 0),s(void 0)},[]),p=m.exports.useCallback(c=>{l(c.currentTarget.value),e(void 0),s(void 0)},[]);function d(){try{const c=J(t),h=I(o);e(A(c,h.resolvers))}catch(c){throw alert(`${c}`),c}}function f(){const c=w.utils.book_new();for(const[O,x]of n){const v=[...x.header],M=w.utils.aoa_to_sheet([v,...x.rows.map(g=>v.map(N=>g[N]!==null?g[N]:"null"))]);w.utils.book_append_sheet(c,M,O)}const h=w.write(c,{type:"array",bookType:"xlsx"});s(URL.createObjectURL(new Blob([h],{type:"application/octet-stream"})))}return y("div",{className:"app",children:[u("h1",{children:"json-flatten-relational"}),u("a",{className:"app__link",href:"https://github.com/pschiffmann/json-flatten-relational#readme",target:"_blank",children:"Docs"}),u("h2",{children:"JSON source"}),u("textarea",{className:"app__textarea",value:t,onChange:i}),u("h2",{children:"Schema"}),u("textarea",{className:"app__textarea",value:o,onChange:p}),u("h2",{children:"Result"}),!n&&u("button",{onClick:d,children:"Run"}),n&&[...n].map(([c,h])=>u(U,{name:c,data:h},c)),n&&(a?u("a",{href:a,download:"untitled.xlsx",children:"Download as .xlsx"}):u("button",{onClick:f,children:"Export as .xslx"}))]})};function J(t){try{return JSON.parse(t)}catch(r){throw r instanceof SyntaxError?new Error(`Invalid JSON source syntax:
${r}`):r}}function I(t){let r;try{r=JSON.parse(t)}catch(o){throw o instanceof SyntaxError?new Error(`Invalid schema syntax:
${o}`):o}if(r.version!=="3")throw new Error("Unsupported schema version.");if(typeof r.resolvers!="object")throw new Error("Schema has no table resolvers.");return r}R.render(u(_.StrictMode,{children:u($,{})}),document.querySelector("#root"));
